<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>SPI Server</title>
<title>CMSIS-Driver Validation: SPI Server</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">CMSIS-Driver Validation
   &#160;<span id="projectnumber">Version 2.0.0</span>
   </div>
   <div id="projectbrief">Driver Validation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__spi__server.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">SPI Server<div class="ingroups"><a class="el" href="group__dv__spi.html">SPI Validation</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>The <b>SPI Server</b> is an application providing a set of features used by the CMSIS-Driver Validation suite to test the physical operation of the SPI driver.<br/>
 It is located in the <code>&lt;pack root directory&gt;</code><b>\Tools\SPI_Server</b> directory.</p>
<p>The SPI Server offers the following features:</p>
<ul>
<li>read of the <b>version</b> information</li>
<li>read of the <b>capabilities</b> information</li>
<li>set and read of the <b>data buffers content</b></li>
<li>read of the last <b>transfer count</b></li>
<li><b>transfer</b> in Slave or Master mode</li>
<li><b>generation of mode fault</b> by activation of the Slave Select line during Slave transfer</li>
</ul>
<h1><a class="anchor" id="spi_server_oper"></a>
Operation</h1>
<p>The SPI Server is continuously waiting on a command from the SPI Client (Driver Validation), after the command is received it is executed, and the process repeats.<br/>
 Most commands do not have any additional related data phase, but some do have additional input or output data exchange phase following the command.</p>
<p>The SPI Server behaves as an SPI Slave except when command for Master transfer was requested, in which case it executes the requested Master transfer and reverts to Slave mode.</p>
<h1><a class="anchor" id="spi_server_config"></a>
Configuration</h1>
<p>Communication interface settings used during command exchange are set in the <b>SPI_Server_Config.h</b> configuration file. </p>
<div class="image">
<img src="spi_server_config_h.png" alt="spi_server_config_h.png"/>
<div class="caption">
SPI_Server_Config.h configuration file in Configuration Wizard view mode</div></div>
 <h2><a class="anchor" id="spi_server_config_detail"></a>
Configuration settings</h2>
<p><b>Driver_SPI#</b> selects the driver instance used by the SPI Server.<br/>
 <b>Communication settings</b> specify the communication parameters for command exchange with the SPI Client:</p>
<ul>
<li><b>Clock / Frame Format</b> setting specifies the clock or frame format used for command exchange.</li>
<li><b>Data Bits</b> setting specifies the number of data bits per item used for command exchange.</li>
<li><b>Bit Order</b> setting specifies the bit order used for command exchange.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The SPI Server is receiving commands operating in SPI Slave mode with usage of the Slave Select line</dd></dl>
<h1><a class="anchor" id="spi_server_commands"></a>
Commands</h1>
<p>Commands are encoded in human readable format (ASCII strings) so they can be viewed by the SPI bus analyzer and analyzed more easily.</p>
<p>Supported commands:</p>
<ul>
<li><b>GET VER</b>: used to retrieve version of the SPI Server application</li>
<li><b>GET CAP</b>: used to retrieve capabilities of the SPI Server (the Server auto-detects capabilities upon reception of this command)</li>
<li><b>SET BUF</b>: used to initialize receive or transmit buffer content of the SPI Server</li>
<li><b>GET BUF</b>: used to retrieve receive or transmit buffer content of the SPI Server</li>
<li><b>SET COM</b>: used to specify transfer configuration for the next transfer</li>
<li><b>XFER</b>: used to trigger a transfer</li>
<li><b>GET CNT</b>: used to retrieve number of transferred items in the last transfer</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>For details about commands please refer to <b>Abstract.txt</b> file in the <code>&lt;pack root directory&gt;</code>\Tools\SPI_Server\Board\MCBSTM32F400 directory.</dd></dl>
<p>Picture below shows a capture of SPI Driver Validation validating functionality of the Master transfer with Slave Select line not used </p>
<div class="image">
<img src="spi_bus_master_ss_unused.png" alt="spi_bus_master_ss_unused.png"/>
</div>
<h1><a class="anchor" id="spi_server_porting"></a>
Porting SPI Server to other targets</h1>
<p>To create SPI Server application for a different target device, follow the steps below:</p>
<ol type="1">
<li>Create a new project in µVision for your target device</li>
<li>In the RTE window enable and configure the following software components:<ul>
<li><b>CMSIS: CORE</b></li>
<li><b>CMSIS: RTOS2 (API): Keil RTX5</b> any variant</li>
<li><b>CMSIS Driver: SPI (API)</b></li>
<li><b>CMSIS Driver: VIO (API)</b> select <b>Virtual</b> implementation if implementation for your target system is not available</li>
<li>Generic device specific components (startup, clock system, I/O, ...) as required (please consult device's documentation for more information)</li>
<li>Resolve any unresolved dependencies between components</li>
</ul>
</li>
<li>Copy the <b>SPI_Server.c</b> file from the <code>&lt;pack root directory&gt;</code><b>\Tools\SPI_Server\Source</b> directory to the project root and add it to µVision project</li>
<li>Copy the <b>SPI_Server.h</b> and <b>SPI_Server_HW.h</b> files from the <code>&lt;pack root directory&gt;</code><b>\Tools\SPI_Server\Include</b> directory to the project root</li>
<li>Copy the files specified below from the directory <code>&lt;pack root directory&gt;</code><b>\Tools\SPI_Server\Config</b> to the project root and add them to µVision project:<ul>
<li><b>SPI_Server_Config.h</b>: also adapt this file as required by your device</li>
<li><b>SPI_Server_HW.c</b>: also adapt this file for your device's specific handling of the SPI Slave Select line</li>
</ul>
</li>
<li>Add root of the project to include path (<b>Options for Target</b> -&gt; <b>C/C++</b> -&gt; <b>Include Paths: .\</b>)</li>
<li>Add the <b>main.c</b> file from a template (Right-click <b>Source Group 1...</b> and select <b>Add New Item to Group</b>, select <b>User Code Template</b> and choose the <b>CMSIS-RTOS2 'main' function</b> file from <b>CMSIS: RTOS2:Keil RTX5</b>) and update with code snippet below (replace <code>app_main</code> function): <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;SPI_Server.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Application main thread</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line">__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> app_main (<span class="keywordtype">void</span> *argument) {</div>
<div class="line">  (void)argument;</div>
<div class="line">  SPI_Server_Start();</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {}</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Build and download the ported SPI Server application to the target device</li>
</ol>
<h1><a class="anchor" id="spi_server_troubleshooting"></a>
Troubleshooting</h1>
<p>Problems and solutions:</p>
<ol type="1">
<li>SPI Server is not responding to commands<ul>
<li>reset the SPI Server</li>
<li>check that communication settings between SPI Server and SPI Driver Validation are the same,<br/>
 if they are not, correct them, rebuild the application and download to the hardware</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="spi_server_MCBSTM32F400"></a>
SPI Server on the Keil MCBSTM32F400</h1>
<p>SPI Server is currently available for the <b>Keil MCBSTM32F400</b> evaluation board.</p>
<p>uVision project and source files are available in the <code>&lt;pack root directory&gt;</code><b>\Tools\SPI_Server\Board\MCBSTM32F400</b> directory.</p>
<p>On the Keil MCBSTM32F400 the <b>SPI2</b> interface is used, with the following pinout:</p>
<table class="doxtable">
<tr>
<th align="left">SPI function </th><th align="center">Pin  </th></tr>
<tr>
<td align="left">SPI Clock </td><td align="center">PB10 </td></tr>
<tr>
<td align="left">Master Output Slave Input (MOSI) </td><td align="center">PB15 </td></tr>
<tr>
<td align="left">Master Input Slave Output (MISO) </td><td align="center">PB14 </td></tr>
<tr>
<td align="left">Slave Select </td><td align="center">PI0 </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>IMPORTANT: Ground must be connected between SPI Server and Device (Driver) Under Test so that SPI signals have same ground potential.</dd></dl>
<p>For more information please consult <b>Abstract.txt</b> file in the project root.</p>
<dl class="section note"><dt>Note</dt><dd>SPI Server on the Keil MCBSTM32F400 does not support National Semiconductor Microwire Frame Format. </dd></dl>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Jul 15 2020 10:47:11 for CMSIS-Driver Validation by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
