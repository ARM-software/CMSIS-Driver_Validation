<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Test Setup</title>
<title>CMSIS-Driver Validation: Test Setup</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">CMSIS-Driver Validation
   &#160;<span id="projectnumber">Version 1.4.0</span>
   </div>
   <div id="projectbrief">Driver Validation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('test_setup.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Test Setup </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="step1"></a>
Step 1: Create an MDK project with your target microcontroller device</h1>
<h1><a class="anchor" id="step2"></a>
Step 2: Add required software components</h1>
<p>For proper operation, add the following software components in the <b>Manage Run-Time Environment</b> window:</p>
<ul>
<li><b>CMSIS Driver Validation:Framework</b></li>
<li><b>CMSIS Driver Validation:driver</b>, driver interfaces to be tested</li>
<li><b>CMSIS Driver:driver</b>, driver implementations to be tested</li>
<li><b>CMSIS:RTOS2 (API):Keil RTX5</b></li>
<li><b>Compiler:I/O:STDOUT</b>, variant <b>ITM</b> (if your hardware does not support ITM select <b>User</b> or <b>EVR</b>)</li>
<li>Resolve any unresolved component dependecies</li>
</ul>
<h1><a class="anchor" id="step3"></a>
Step 3: Add main.c</h1>
<p>Right-click <b>Source Group 1...</b> and select <b>Add New Item to Group</b>. Select <b>User Code Template</b> and choose the <b>main</b> file from <b>Device:Startup</b> or <b>CMSIS-RTOS2:Keil RTX5</b>.</p>
<p>Add this include: </p>
<div class="fragment"><div class="line">include <span class="stringliteral">&quot;cmsis_dv.h&quot;</span></div>
</div><!-- fragment --><p>In the main function, after kernel initialization, create the <code>cmsis_dv</code> thread: </p>
<div class="fragment"><div class="line">osThreadNew(<a class="code" href="group__framework__funcs.html#gaf2fc6d3011404f9d07346948bcc6c74d">cmsis_dv</a>, NULL, NULL);</div>
</div><!-- fragment --><p> to run all tests that you have chosen in the next step.</p>
<h1><a class="anchor" id="step4"></a>
Step 4: Configure DV_Config.h</h1>
<p>Open <code>DV_Config.h</code> under the <b>CMSIS Driver Validation</b> group in the Project window.</p>
<div class="image">
<img src="dv_config_h.png" alt="dv_config_h.png"/>
<div class="caption">
Configuration File DV_Config.h</div></div>
<p> <b>Common Test Settings</b></p>
<p>The common test settings help you to choose the output format of the test, buffer sizes and buffer content that should be used for the send, receive, and transfer tests:</p>
<ul>
<li>The <b>Print</b> <b>Output</b> <b>Format</b> lets you select if you wish to create the output as plain text or as styled XML.</li>
<li><b>Buffer</b> <b>sizes</b> lets you select the buffer sizes that are used for data transfer. This setting has a direct impact on required <a class="el" href="test_setup.html#step6">heap</a>.</li>
<li>You can specify also the <b>Buffer size for baudrate test</b>. For USART you can set the <b>Percentual tolerance for baudrate test</b> and for SPI the <b>Percentual trigger for bus speed test</b>. Depending on the device <a class="el" href="test_setup.html#step7">configuration</a>, for example when DMA is not used, the transfers may have larger overhead which is more significant for higher bus speeds. The transfer overhead is reduced for larger transfer buffer sizes.</li>
<li>Select your preferred <b>Buffer pattern</b></li>
</ul>
<p><b>Driver-specific Settings</b></p>
<p>Every interface has specific settings that can be changed in the according section:</p>
<ul>
<li>You need to specify the driver instance number (<b>Driver_<em>interface</em>#</b>) used for the test. This is especially important for microcontroller devices that have multiple peripherals of the same kind.</li>
<li>Some drivers can have additional baudrate or timing settings.</li>
<li>Select all driver tests that you wish to use. Note that all tests can run independently from each other. You do not need to specify a certain order.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>For more information on additional settings and the different driver test cases, check the <a href="./modules.html" class="el">Reference</a> section. </dd>
<dd>
For WiFi driver validation some settings depend on the test environment and they need to be set properly, for details please refer to <a class="el" href="group__wifi__config.html">WiFi Configuration</a> section.</dd></dl>
<h1><a class="anchor" id="step5"></a>
Step 5: Configure Keil RTX5</h1>
<p>Open <b>RTX_Config.h</b> and set:</p>
<ul>
<li><b>Default Thread stack size [bytes]</b> to <em>2048</em> </li>
<li><b>Global Dynamic Memory size [bytes]</b> to <em>8192</em> (Note 1)</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Note 1: This setting is only necessary for WiFi driver testing, for other tests default setting of 4096 is sufficient.</dd></dl>
<h1><a class="anchor" id="step6"></a>
Step 6: Configure Heap</h1>
<p>Depending on the buffer sizes that you have chosen in <a class="el" href="test_setup.html#step4">Step 4</a>, you need to add more heap. Depending on how heap is configured in your system open your startup_<em>device</em>.s file from the <b>Device</b> group in the <b>Project</b> window or use a linker script to adjust the heap setting. Click on the <a href="http://www.keil.com/support/man/docs/uv4/uv4_ut_configwizard.htm" target="_blank">Configuration Wizard</a> view. Increase the heap size:</p>
<ul>
<li>for the validation framework add 1024 bytes.</li>
<li>double the largest buffer size you have set in the configuration file and add this as well.</li>
</ul>
<p>Refer to the <a class="el" href="resource_requirements.html">Resource Requirements</a> section for a calculation example.</p>
<h1><a class="anchor" id="step7"></a>
Step 7: Configure the Device</h1>
<p>Depending on your device, you might have different pin/hardware configuration options. Usually, you can configure the device using the <code>RTE_Device.h</code> file from the <b>Device</b> group. Enable all interfaces you wish to use in the tests and make all necessary pin-out changes required by your actual board layout (consult the board schematics). The pre-built <a class="el" href="examples.html">examples</a> are already configured for the underlying hardware.</p>
<p>For a robust test with good coverage, implement various targets with different settings:</p>
<ul>
<li><b>Enable/disable</b> the <b>DMA</b> controller of your device</li>
<li>Set different <b>buffer</b> <b>sizes</b> in <a class="el" href="test_setup.html#step4">DV_Config.h</a></li>
<li>Select different compiler <b>optimization</b> <b>levels</b> in the <a href="http://www.keil.com/support/man/docs/uv4/uv4_dg_adscc.htm" target="_blank">C/C++ tab</a> of the <b>Options for Target</b> dialog.</li>
</ul>
<h1><a class="anchor" id="step8"></a>
Step 8: Setup Additional Hardware</h1>
<p>For the interfaces that support loopback testing: <a class="el" href="group__eth__funcs.html">Ethernet</a>, <a class="el" href="group__spi__funcs.html">SPI</a>, and <a class="el" href="group__usart__funcs.html">USART</a>, connect the following pins on your target hardware together (refer to the hardware schematics):</p>
<ul>
<li>Ethernet: RX+ and TX+, RX- and TX-</li>
<li>SPI: MISO and MOSI</li>
<li>USART: RX and TX</li>
</ul>
<p>For WiFi specific hardware requirements please refer to <a class="el" href="group__wifi__requirements.html">WiFi Requirements</a>.</p>
<h1><a class="anchor" id="step9"></a>
Step 9: Download and Run the Project</h1>
<p>In the <b>Options for Target</b> dialog, under debug settings, if you use ITM as standard output channel ensure that <b>Trace</b> and ITM port <span class="XML-Token">0</span> are enabled and that the correct clock frequency is set:</p>
<div class="image">
<img src="target_dialog.png" alt="target_dialog.png"/>
<div class="caption">
ITM Channel setting</div></div>
<p> Build, load and run the project. The output is displayed in the <b>Debug (printf) Viewer</b> window:</p>
<pre class="fragment">CMSIS-Driver ETH Test Report   Nov 15 2019   15:25:59 

TEST 01: ETH_MAC_GetCapabilities          PASSED
TEST 02: ETH_MAC_Initialization           PASSED
TEST 03: ETH_MAC_PowerControl             
  DV_ETH.c (163): [WARNING] Low power is not supported
                                          PASSED
TEST 04: ETH_MAC_SetBusSpeed              
  DV_ETH.c (197): [WARNING] Link speed 1G is not supported
                                          PASSED
TEST 05: ETH_MAC_Config_Mode              PASSED
TEST 06: ETH_MAC_Config_CommonParams      PASSED
TEST 07: ETH_PHY_Initialization           PASSED
TEST 08: ETH_PHY_PowerControl             
  DV_ETH.c (300): [WARNING] Low power is not supported
                                          PASSED
TEST 09: ETH_PHY_Config                   PASSED
TEST 10: ETH_Loopback_Transfer            PASSED
TEST 11: ETH_PHY_CheckInvalidInit         NOT EXECUTED
TEST 12: ETH_MAC_CheckInvalidInit         NOT EXECUTED

Test Summary: 12 Tests, 10 Passed, 0 Failed.
Test Result: PASSED
</pre><p>If you see warnings during loopback transfer tests, please read the section <a class="el" href="test_results.html">Reading Test Results</a> which gives you more information on how to interpret the results. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Dec 2 2019 12:02:22 for CMSIS-Driver Validation by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
